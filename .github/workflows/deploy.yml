name: Deploy Go App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Stop the service first if it exists
    - name: SSH Stop service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          sudo systemctl stop myapp || echo "Service not running"

    # Install Go locally for the user (no sudo required)
    - name: SSH Install Go (user-local)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          GO_VERSION="1.23.6"
          mkdir -p ~/go
          wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz -O /tmp/go.tar.gz
          rm -rf ~/go/go
          tar -C ~/go -xzf /tmp/go.tar.gz
          rm /tmp/go.tar.gz
          export PATH=$HOME/go/go/bin:$PATH
          go version

    # Clone or update repo
    - name: SSH Clone or update repo
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          if [ ! -d "/home/ben/PersonalWebsiteGO" ]; then
              git clone https://github.com/benjamano/PersonalWebsiteGO /home/ben/PersonalWebsiteGO
              echo "Repo cloned"
          else
              cd /home/ben/PersonalWebsiteGO
              git reset --hard
              git clean -fd
              git pull origin main
              echo "Repo updated"
          fi

    # Build the Go app using user-local Go
    - name: SSH Build app
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          export PATH=$HOME/go/go/bin:$PATH
          cd /home/ben/PersonalWebsiteGO
          go build -o myapp
          chmod +x myapp
          echo "App built"

    # Create or update systemd service
    - name: SSH Create systemd service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          sudo tee /etc/systemd/system/myapp.service > /dev/null <<EOF
          [Unit]
          Description=Personal Website Go App
          After=network.target

          [Service]
          Type=simple
          User=ben
          WorkingDirectory=/home/ben/PersonalWebsiteGO
          ExecStart=/home/ben/PersonalWebsiteGO/myapp
          Restart=always
          RestartSec=5
          StandardOutput=append:/home/ben/PersonalWebsiteGO/myapp.log
          StandardError=append:/home/ben/PersonalWebsiteGO/myapp.log

          [Install]
          WantedBy=multi-user.target
          EOF

          sudo systemctl daemon-reload
          sudo systemctl enable myapp
          echo "Service created and enabled"

    # Start/restart the service
    - name: SSH Restart service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          sudo systemctl restart myapp
          sudo systemctl status myapp
          echo "Service restarted"
