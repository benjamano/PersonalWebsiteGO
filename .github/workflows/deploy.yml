name: Deploy Go App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest   # keep a GitHub Linux runner

    steps:
    - name: SSH Remove existing Go
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          sudo rm -rf /usr/local/go
          echo "Old Go removed"

    - name: SSH Install Go
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          GO_VERSION="1.23.6"
          wget https://golang.org/dl/go${GO_VERSION}.linux-armv7l.tar.gz -O /tmp/go.tar.gz
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          rm /tmp/go.tar.gz
          echo "Go installed"
          /usr/local/go/bin/go version

    - name: SSH Clone or update repo
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          if [ ! -d "/home/benmercer/PersonalWebsiteGO" ]; then
              git clone https://github.com/benjamano/PersonalWebsiteGO /home/benmercer/PersonalWebsiteGO
              echo "Repo cloned"
          else
              cd /home/benmercer/PersonalWebsiteGO
              git reset --hard
              git clean -fd
              git pull origin main
              echo "Repo updated"
          fi

    - name: SSH Stop existing app
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          pkill myapp || echo "No running process to stop"

    - name: SSH Build app
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          cd /home/benmercer/PersonalWebsiteGO
          /usr/local/go/bin/go build -o myapp
          echo "App built"

    - name: SSH Start app
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: 2222
        script: |
          cd /home/benmercer/PersonalWebsiteGO
          nohup ./myapp > myapp.log 2>&1 &
          echo "App started"