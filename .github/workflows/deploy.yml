name: Deploy Go App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    steps:
    - name: Remove existing Go
      run: |
        if (Test-Path "C:\Go") { Remove-Item -Recurse -Force "C:\Go" }
        Write-Host "Old Go removed"

    - name: Install Go
      run: |
        $GO_VERSION = "1.23.6"
        $zip = "C:\Windows\Temp\go.zip"
        Invoke-WebRequest -Uri "https://go.dev/dl/go$GO_VERSION.windows-amd64.zip" -OutFile $zip
        Expand-Archive -Path $zip -DestinationPath "C:\" -Force
        Remove-Item $zip
        Write-Host "Go installed"
        & "C:\Go\bin\go.exe" version

    - name: Clone or update repo
      run: |
        $repoPath = "C:\Users\Public\PersonalWebsiteGO"
        if (-Not (Test-Path $repoPath)) {
          git clone https://github.com/benjamano/PersonalWebsiteGO $repoPath
          Write-Host "Repo cloned"
        } else {
          Set-Location $repoPath
          git reset --hard
          git clean -fd
          git pull origin main
          Write-Host "Repo updated"
        }

    - name: Stop existing app
      run: |
        $process = Get-Process -Name myapp -ErrorAction SilentlyContinue
        if ($process) { $process | Stop-Process -Force }
        Write-Host "Existing app stopped"

    - name: Build app
      run: |
        Set-Location "C:\Users\Public\PersonalWebsiteGO"
        & "C:\Go\bin\go.exe" build -o myapp.exe
        Write-Host "App built"

    - name: Start app
      run: |
        Set-Location "C:\Users\Public\PersonalWebsiteGO"
        Start-Process ".\myapp.exe"
        Write-Host "App started"
