<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="container my-5 mt-2">
    <div class="text-center mb-0">
        <h1 class="mb-4 display-5">Blog Posts</h1>
    </div>
    
    <!-- <div id="loggedInStatus" class="alert alert-success alert-dismissible fade show d-none" role="alert">
        <i class="bi bi-check-circle-fill"></i> You are logged in as an admin
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
     -->
    {{if .Error}}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{.Error}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{end}}
    
    <div class="mb-4 d-flex gap-2 justify-content-center">
        <button id="addBlogBtn" class="btn btn-outline-primary d-none" onclick="toggleBlogForm()">
            <i class="bi bi-plus-circle"></i> Add New Blog Post
        </button>
    </div>
    
    <div id="blogForm" class="card mb-4 d-none">
        <div class="card-body">
            <h2 class="card-title mb-4" id="formTitle">Create New Blog Post</h2>
            <input type="hidden" id="blogId" value="">
            <form onsubmit="submitBlog(event)">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                
                <div class="mb-3">
                    <label for="author" class="form-label">Author</label>
                    <input type="text" class="form-control" id="author" name="author" required value="Ben Mercer">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    
                    <!-- Editor Tabs -->
                    <ul class="nav nav-tabs editor-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual-editor" type="button" role="tab">
                                <i class="bi bi-pencil-square"></i> Visual Editor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-editor" type="button" role="tab" onclick="syncToHtmlSource()">
                                <i class="bi bi-code-slash"></i> HTML Source
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview-editor" type="button" role="tab" onclick="syncToPreview()">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content border border-top-0 rounded-bottom">
                        <!-- Visual Editor Tab -->
                        <div class="tab-pane fade show active p-3 bg-white" id="visual-editor" role="tabpanel">
                            <div id="editor-container" style="height: 400px;"></div>
                        </div>
                        
                        <!-- HTML Source Tab -->
                        <div class="tab-pane fade p-3 bg-white" id="html-editor" role="tabpanel">
                            <textarea class="form-control font-monospace" id="htmlSource" rows="15" style="min-height: 400px;" placeholder="HTML source code"></textarea>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="syncFromHtmlSource()">
                                <i class="bi bi-arrow-clockwise"></i> Apply HTML Changes
                            </button>
                        </div>
                        
                        <!-- Preview Tab -->
                        <div class="tab-pane fade p-3 bg-white" id="preview-editor" role="tabpanel">
                            <div id="htmlPreview" class="border rounded p-3 bg-white" style="min-height: 400px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Publish
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="toggleBlogForm()">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {{if .Blogs}}
        {{range .Blogs}}
        <div class="card mb-4 shadow-sm" data-blog-id="{{.ID}}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h2 class="card-title mb-0">{{.Title}}</h2>
                    <div class="admin-actions d-none">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editBlog({{.ID}})">
                            <i class="bi bi-pencil-fill"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBlog({{.ID}})">
                            <i class="bi bi-trash-fill"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="text-muted small mb-3">
                    <span class="me-3"><i class="bi bi-person-fill"></i> <strong>Author:</strong> {{.Author}}</span>
                    <span class="me-3"><i class="bi bi-calendar-fill"></i> <strong>Posted:</strong> {{.CreatedAt.Format "January 2, 2006"}}</span>
                    {{if ne .CreatedAt .UpdatedAt}}
                    <span><i class="bi bi-pencil-fill"></i> <strong>Updated:</strong> {{.UpdatedAt.Format "January 2, 2006"}}</span>
                    {{end}}
                </div>
                <div class="lh-base blog-content">
                    {{.Content}}
                </div>
            </div>
        </div>
        {{end}}
    {{else}}
        <div class="text-center py-5">
            <i class="bi bi-journal-x display-1 text-muted"></i>
            <h2 class="mt-3">No blog posts yet</h2>
            <p class="text-muted">Be the first to create a blog post!</p>
        </div>
    {{end}}
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
    let quill;
        if (typeof window.authToken === 'undefined') {
            window.authToken = localStorage.getItem('authToken');
    }

    window.addEventListener('DOMContentLoaded', () => {
        initializeEditor();
        checkAuthStatus();
    });
    
    function initializeEditor() {
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            },
            placeholder: 'Write your blog content here...'
        });
    }
    
    function syncToHtmlSource() {
        const html = quill.root.innerHTML;
        document.getElementById('htmlSource').value = html;
    }
    
    function syncFromHtmlSource() {
        const html = document.getElementById('htmlSource').value;
        quill.root.innerHTML = html;
    }
    
    function syncToPreview() {
        const html = quill.root.innerHTML;
        document.getElementById('htmlPreview').innerHTML = html;
    }
    
    async function checkAuthStatus() {
        const addBlogBtn = document.getElementById('addBlogBtn');
        const headerLoginBtn = document.getElementById('headerLoginBtn');
        const headerLogoutBtn = document.getElementById('headerLogoutBtn');
        const loggedInStatus = document.getElementById('loggedInStatus');
        const adminActions = document.querySelectorAll('.admin-actions');

        if (!authToken) {
            addBlogBtn.classList.add('d-none');
            if (headerLoginBtn) headerLoginBtn.classList.remove('d-none');
            if (headerLogoutBtn) headerLogoutBtn.classList.add('d-none');
            adminActions.forEach(action => action.classList.add('d-none'));
            return;
        }

        try {
            const response = await fetch('/api/auth/check', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (response.ok) {
                addBlogBtn.classList.remove('d-none');
                if (headerLoginBtn) headerLoginBtn.classList.add('d-none');
                if (headerLogoutBtn) headerLogoutBtn.classList.remove('d-none');
                adminActions.forEach(action => action.classList.remove('d-none'));
            } else {
                localStorage.removeItem('authToken');
                authToken = null;
                addBlogBtn.classList.add('d-none');
                if (headerLoginBtn) headerLoginBtn.classList.remove('d-none');
                if (headerLogoutBtn) headerLogoutBtn.classList.add('d-none');
                adminActions.forEach(action => action.classList.add('d-none'));
            }
        } catch (error) {
            console.error('Error checking auth:', error);
            localStorage.removeItem('authToken');
            authToken = null;
            addBlogBtn.classList.add('d-none');
            if (headerLoginBtn) headerLoginBtn.classList.remove('d-none');
            if (headerLogoutBtn) headerLogoutBtn.classList.add('d-none');
            adminActions.forEach(action => action.classList.add('d-none'));
        }
    }
    
    function toggleBlogForm() {
        const form = document.getElementById('blogForm');
        form.classList.toggle('d-none');
        
        // Clear the editor when closing
        if (form.classList.contains('d-none')) {
            clearBlogForm();
        } else {
            // Scroll to form when opening
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    function clearBlogForm() {
        quill.setContents([]);
        document.getElementById('title').value = '';
        document.getElementById('author').value = '';
        document.getElementById('blogId').value = '';
        document.getElementById('formTitle').textContent = 'Create New Blog Post';
    }
    
    async function submitBlog(event) {
        event.preventDefault();
        
        if (!authToken) {
            alert('You must be logged in to create a blog post');
            return;
        }
        
        // Get HTML content from Quill editor
        const htmlContent = quill.root.innerHTML;
        const blogId = document.getElementById('blogId').value;
        
        const formData = {
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            content: htmlContent
        };
        
        const isEditing = blogId !== '';
        const url = isEditing ? `/api/blogs/${blogId}` : '/api/blogs';
        const method = isEditing ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                alert(isEditing ? 'Blog post updated successfully!' : 'Blog post created successfully!');
                window.location.reload();
            } else if (response.status === 401) {
                alert('Your session has expired. Please login again.');
                localStorage.removeItem('authToken');
                authToken = null;
                checkAuthStatus();
                loginModal.show();
            } else {
                alert(isEditing ? 'Failed to update blog post' : 'Failed to create blog post');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while ' + (isEditing ? 'updating' : 'creating') + ' the blog post');
        }
    }
    
    async function editBlog(blogId) {
        if (!authToken) {
            alert('You must be logged in to edit blog posts');
            return;
        }
        
        try {
            const response = await fetch(`/api/blogs/${blogId}`);
            
            if (response.ok) {
                const blog = await response.json();
                
                // Populate the form
                document.getElementById('title').value = blog.title;
                document.getElementById('author').value = blog.author;
                document.getElementById('blogId').value = blog.id;
                document.getElementById('formTitle').textContent = 'Edit Blog Post';
                
                // Set content in Quill editor
                quill.root.innerHTML = blog.content;
                
                // Show the form
                const form = document.getElementById('blogForm');
                form.classList.remove('d-none');
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                alert('Failed to load blog post');
            }
        } catch (error) {
            console.error('Error loading blog:', error);
            alert('An error occurred while loading the blog post');
        }
    }
    
    async function deleteBlog(blogId) {
        if (!authToken) {
            alert('You must be logged in to delete blog posts');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this blog post? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/blogs/${blogId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.ok) {
                alert('Blog post deleted successfully!');
                window.location.reload();
            } else if (response.status === 401) {
                alert('Your session has expired. Please login again.');
                localStorage.removeItem('authToken');
                authToken = null;
                checkAuthStatus();
                loginModal.show();
            } else {
                alert('Failed to delete blog post');
            }
        } catch (error) {
            console.error('Error deleting blog:', error);
            alert('An error occurred while deleting the blog post');
        }
    }
</script>